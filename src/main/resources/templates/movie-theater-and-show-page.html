<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theaters for <span th:text="${movie.title}">Movie</span> - Movie Booking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #0f172a;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #e2e8f0;
        }
        
        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .movie-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .movie-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
        }
        
        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            transform: translateY(-2px);
        }
        
        .date-selection-section {
            background: rgba(30, 41, 59, 0.95);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border: 1px solid rgba(148, 163, 184, 0.2);
            backdrop-filter: blur(20px);
        }
        
        .quick-date-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .quick-date-btn {
            background: rgba(51, 65, 85, 0.8);
            border: 2px solid rgba(148, 163, 184, 0.3);
            color: #cbd5e1;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .quick-date-btn:hover {
            background: rgba(129, 140, 248, 0.2);
            border-color: #818cf8;
            color: #e2e8f0;
            transform: translateY(-1px);
        }
        
        .quick-date-btn.active {
            background: #818cf8;
            border-color: #818cf8;
            color: white;
        }
        
        .date-picker-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .date-input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .date-input-group label {
            color: #cbd5e1;
            font-weight: 600;
            font-size: 0.9rem;
            display: none;
        }
        
        .date-input {
            background: rgba(51, 65, 85, 0.8);
            border: 2px solid rgba(148, 163, 184, 0.3);
            color: #e2e8f0;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: none;
        }
        
        .date-input:focus {
            outline: none;
            border-color: #818cf8;
            box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.2);
            background: rgba(51, 65, 85, 0.95);
        }
        
        .theater-container {
            background: rgba(30, 41, 59, 0.95);
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            overflow: hidden;
            border: 1px solid rgba(148, 163, 184, 0.2);
            backdrop-filter: blur(20px);
        }
        
        .theater-row {
            display: flex;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }
        
        .theater-row:last-child {
            border-bottom: none;
        }
        
        .theater-logo {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
            color: white;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .pvr-logo {
            background: #f59e0b;
        }
        
        .cinepolis-logo {
            background: #3b82f6;
        }
        
        .inox-logo {
            background: #10b981;
        }
        
        .rajhans-logo {
            background: #f97316;
        }
        
        .mango-logo {
            background: #ef4444;
        }
        
        .theater-info {
            flex: 1;
            margin-right: 20px;
        }
        
        .theater-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-icon {
            color: #94a3b8;
            font-size: 0.9rem;
            cursor: pointer;
        }
        
        .theater-features {
            display: flex;
            gap: 15px;
            margin-top: 8px;
        }
        
        .feature-icon {
            color: #10b981;
            font-size: 0.9rem;
        }
        
        .showtimes-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .favorite-icon {
            color: #94a3b8;
            font-size: 1.2rem;
            cursor: pointer;
            margin-bottom: 10px;
            transition: color 0.3s ease;
        }
        
        .favorite-icon:hover {
            color: #ef4444;
        }
        
        .favorite-icon.active {
            color: #ef4444;
        }
        
        .showtime-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .showtime-btn {
            background: rgba(51, 65, 85, 0.8);
            border: 2px solid #10b981;
            color: #10b981;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .showtime-btn:hover {
            background: #10b981;
            color: white;
            transform: translateY(-1px);
        }
        
        .audio-format {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 2px;
        }
        
        .cancellation-policy {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-top: 5px;
        }
        
        .cancellation-available {
            color: #10b981;
        }
        
        .cancellation-not-available {
            color: #ef4444;
        }
        
        .no-theaters {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8;
        }
        
        .no-theaters-icon {
            font-size: 4rem;
            color: #475569;
            margin-bottom: 20px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
            color: white;
        }
        
        @media (max-width: 768px) {
            .date-picker-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .quick-date-buttons {
                justify-content: center;
            }
            
            .theater-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .theater-info {
                margin-right: 0;
                width: 100%;
            }
            
            .showtimes-section {
                width: 100%;
                align-items: flex-start;
            }
            
            .showtime-buttons {
                justify-content: flex-start;
            }
            
            .movie-title {
                font-size: 1.4rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header with Movie Title -->
    <div class="header">
        <div class="container">
            <div class="movie-header">
                <div class="d-flex align-items-center gap-3">
                    <a href="/movies/moviesbycitypage" class="text-white text-decoration-none">
                        <h1 class="h3 m-0 fw-bold">ðŸŽ¬ Movie Booking</h1>
                    </a>
                    <span class="text-white-50">|</span>
                    <h2 class="movie-title m-0">
                        <span th:text="${movie != null ? movie.title : 'Movie Details'}">Movie Title</span>
                    </h2>
                </div>
                <a href="javascript:void(0)" onclick="goBackWithCity()" class="back-btn">
                    <i class="fas fa-arrow-left me-2"></i>Back
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Date Selection Section -->
        <div class="date-selection-section">
            <h5 class="mb-3">
                Select Date for Showtimes
            </h5>
            
            <div class="date-picker-container">
                <div class="date-input-group">
                    <label for="selectedDate">Choose Date:</label>
                    <input type="date" id="selectedDate" class="date-input" 
                           th:value="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}"
                           min="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}"
                           max="${#dates.format(#dates.add(#dates.createNow(), 'P30D'), 'yyyy-MM-dd')}">
                </div>
                
                <div class="quick-date-buttons">
                    <button type="button" class="quick-date-btn active" data-days="0" id="today-btn">Loading...</button>
                    <button type="button" class="quick-date-btn" data-days="1" id="tomorrow-btn">Loading...</button>
                    <button type="button" class="quick-date-btn" data-days="2" id="day-after-btn">Loading...</button>
                    <button type="button" class="quick-date-btn" data-days="7" id="next-week-btn">Loading...</button>
                </div>
            </div>
        </div>

        <!-- Theaters List -->
        <div th:if="${theaterAndShowMap != null and !theaterAndShowMap.isEmpty()}" id="theaters-container">
            <div th:each="entry : ${theaterAndShowMap}" class="theater-container">
                <div class="theater-row">
                    <!-- Theater Logo -->
                    <div class="theater-logo" th:classappend="${entry.key.name.toLowerCase().contains('pvr') ? 'pvr-logo' : 
                                                              entry.key.name.toLowerCase().contains('cinepolis') ? 'cinepolis-logo' :
                                                              entry.key.name.toLowerCase().contains('inox') ? 'inox-logo' :
                                                              entry.key.name.toLowerCase().contains('rajhans') ? 'rajhans-logo' :
                                                              'mango-logo'}">
                        <span th:text="${entry.key.name.substring(0, 1)}">T</span>
                    </div>
                    
                    <!-- Theater Info -->
                    <div class="theater-info">
                        <div class="theater-name">
                            <span th:text="${entry.key.name + ': ' + entry.key.city}">Theater Name: Location</span>
                            <i class="fas fa-info-circle info-icon" title="Theater Information"></i>
                        </div>
                        <div class="theater-features">
                            <i class="fas fa-utensils feature-icon" title="Food & Beverages"></i>
                            <i class="fas fa-ticket-alt feature-icon" title="Ticket Types"></i>
                        </div>
                    </div>
                    
                    <!-- Showtimes Section -->
                    <div class="showtimes-section">
                        <i class="far fa-heart favorite-icon" title="Add to Favorites"></i>
                        
                        <div class="showtime-buttons">
                            <a th:href="@{/shows/showseatselectionpage/{id}(id=${show.id})}" 
                            class="showtime-btn" 
                            th:each="show : ${entry.value}" 
                            th:text="${#temporals.format(show.showTime, 'hh:mm a')}">
                            07:20 PM
                         </a>
                        </div>
                        
                        <div class="audio-format" th:if="${!entry.value.isEmpty()}">
                            DOLBY 7.1
                        </div>
                        
                        <div class="cancellation-policy" 
                             th:classappend="${entry.key.name.toLowerCase().contains('pvr') or entry.key.name.toLowerCase().contains('inox') or entry.key.name.toLowerCase().contains('mango') ? 'cancellation-available' : 'cancellation-not-available'}">
                            <span th:if="${entry.key.name.toLowerCase().contains('pvr') or entry.key.name.toLowerCase().contains('inox') or entry.key.name.toLowerCase().contains('mango')}">
                                Cancellation available
                            </span>
                            <span th:unless="${entry.key.name.toLowerCase().contains('pvr') or entry.key.name.toLowerCase().contains('inox') or entry.key.name.toLowerCase().contains('mango')}">
                                Non-cancellable
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- No Theaters Found -->
        <div th:if="${theaterAndShowMap == null or theaterAndShowMap.isEmpty()}" class="no-theaters" id="no-theaters">
            <div class="no-theaters-icon">
                <i class="fas fa-building"></i>
            </div>
            <h3>No Theaters Found</h3>
            <p>Sorry, no theaters are currently showing this movie.</p>
            <a href="javascript:void(0)" onclick="goBackWithCity()" class="btn btn-primary">
                <i class="fas fa-arrow-left me-2"></i>Go Back
            </a>
        </div>
        
        <!-- Hidden city data for JavaScript -->
        <div th:each="entry, entryStat : ${theaterAndShowMap}" 
             th:if="${entryStat.first}"
             th:attr="data-selected-city=${entry.key.city}"
             style="display: none;"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Set initial date to today
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            document.getElementById('selectedDate').value = todayString;
            
            // Populate quick date buttons with actual dates
            populateQuickDateButtons();
            
            // Get the date from URL parameters to determine which button should be active
            const urlParams = new URLSearchParams(window.location.search);
            const urlDate = urlParams.get('date');
            
            if (urlDate) {
                // Set the date input to the URL date
                document.getElementById('selectedDate').value = urlDate;
                
                // Calculate which button should be active based on the URL date
                const urlDateObj = new Date(urlDate);
                const todayObj = new Date();
                const diffTime = urlDateObj.getTime() - todayObj.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                // Set the appropriate button as active
                updateQuickDateButtons(diffDays);
            } else {
                // No date in URL, set today button as active
                updateQuickDateButtons(0);
            }
            
            // Add initial event listeners
            addEventListeners();
        });
        
        function populateQuickDateButtons() {
            const today = new Date();
            
            // Today button
            const todayBtn = document.getElementById('today-btn');
            todayBtn.textContent = formatDateForDisplay(today);
            
            // Tomorrow button
            const tomorrowBtn = document.getElementById('tomorrow-btn');
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            tomorrowBtn.textContent = formatDateForDisplay(tomorrow);
            
            // Day After button
            const dayAfterBtn = document.getElementById('day-after-btn');
            const dayAfter = new Date(today);
            dayAfter.setDate(today.getDate() + 2);
            dayAfterBtn.textContent = formatDateForDisplay(dayAfter);
            
            // Next Week button
            const nextWeekBtn = document.getElementById('next-week-btn');
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            nextWeekBtn.textContent = formatDateForDisplay(nextWeek);
        }
        
        function formatDateForDisplay(date) {
            const day = date.getDate();
            const month = date.toLocaleDateString('en-US', { month: 'short' });
            return `${day}-${month}`;
        }
        
        function addEventListeners() {
            // Add favorite functionality
            document.querySelectorAll('.favorite-icon').forEach(icon => {
                icon.addEventListener('click', function() {
                    this.classList.toggle('active');
                    this.classList.toggle('far');
                    this.classList.toggle('fas');
                });
            });
            
            // Add showtime button functionality
            document.querySelectorAll('.showtime-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    console.log('Showtime selected:', this.textContent);
                });
            });
            
            // Add info icon functionality
            document.querySelectorAll('.info-icon').forEach(icon => {
                icon.addEventListener('click', function() {
                    console.log('Theater info clicked');
                });
            });
        }
        
        // Quick date button functionality
        document.querySelectorAll('.quick-date-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const days = parseInt(this.getAttribute('data-days'));
                const targetDate = new Date();
                targetDate.setDate(targetDate.getDate() + days);
                
                const dateString = targetDate.toISOString().split('T')[0];
                document.getElementById('selectedDate').value = dateString;
                
                // Update active button
                updateQuickDateButtons(days);
                
                // Reload page with new date instead of AJAX filtering
                reloadPageWithNewDate(dateString);
            });
        });
        
        function updateQuickDateButtons(activeDays) {
            document.querySelectorAll('.quick-date-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.getAttribute('data-days')) === activeDays) {
                    btn.classList.add('active');
                }
            });
        }
        
        function reloadPageWithNewDate(selectedDate) {
            const movieId = getMovieIdFromPage();
            const city = getCityFromPage();
            
            console.log('Reloading page with:', { movieId, city, selectedDate });
            
            // Redirect to the same page with new date parameters
            window.location.href = `/movies/moviedetailspage?movieId=${movieId}&city=${city}&date=${selectedDate}`;
        }
        
        function getMovieIdFromPage() {
            // Extract movie ID from the page URL or data attributes
            const urlParams = new URLSearchParams(window.location.search);
            const movieId = urlParams.get('movieId');
            
            if (movieId) {
                return movieId;
            }
            
            // Try to get from URL path
            const pathParts = window.location.pathname.split('/');
            const movieIndex = pathParts.findIndex(part => part === 'movie');
            if (movieIndex !== -1 && pathParts[movieIndex + 1]) {
                return pathParts[movieIndex + 1];
            }
            
            // Default fallback
            return '1';
        }
        
        function getCityFromPage() {
            // Try to get city from hidden data attribute
            const cityElement = document.querySelector('[data-selected-city]');
            if (cityElement) {
                const city = cityElement.getAttribute('data-selected-city');
                if (city) {
                    return city;
                }
            }
            
            // Try to get from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const city = urlParams.get('city');
            if (city) {
                return city;
            }
            
            // Try to extract from theater data
            const theaterNames = document.querySelectorAll('.theater-name span');
            if (theaterNames.length > 0) {
                const firstTheaterText = theaterNames[0].textContent;
                const cityMatch = firstTheaterText.match(/: ([^,]+)/);
                if (cityMatch) {
                    return cityMatch[1].trim();
                }
            }
            
            // Default fallback
            return 'MUMBAI';
        }

        function goBackWithCity() {
            const city = getCityFromPage();
            
            console.log('Going back to movie list with city:', city);
            
            window.location.href = `/movies/moviesbycitypage?city=${city}`;
        }
    </script>
</body>
</html>
